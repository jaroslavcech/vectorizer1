# Clustering

This Python script performs clustering on text embeddings stored in a PostgreSQL database. Each record is assigned a cluster ID and a human-readable cluster name (generated by ChatGPT). The script does the following:

1. **Establishes a Connection to the Database**  
   - Uses environment variables (retrieved by `get_env()`) to connect to the PostgreSQL database.
   - Initializes columns for cluster IDs and names in the target table if they do not exist.

2. **Loads Embeddings**  
   - Reads rows from the specified table, including the `id`, file name, page number, position, text chunk, and the text embedding.
   - Converts the embedding from string or database vector type into a NumPy array for clustering.

3. **Clustering**  
   - Applies the K-Means algorithm to cluster embeddings into `n_clusters`.
   - Identifies the text chunk closest to each cluster center and prompts ChatGPT to name the cluster in a concise, human-readable format.

4. **Updates the Table**  
   - Writes the cluster ID (`cluster_id`) and cluster name (`cluster`) back into the database table.

5. **Outputs the Result**  
   - Prints the clustered output in JSON format, including file name, page, position, chunk text, cluster ID, and cluster name.

## Requirements

- Python 3.7+
- `psycopg2` (PostgreSQL driver)
- `numpy`
- `scikit-learn`
- `openai` (for ChatGPT model calls)

## Setup

1. **Install Dependencies**  
   ```bash
   pip install psycopg2 numpy scikit-learn openai
   ```

2. **Prepare Environment Variables**  
   You must provide the following environment variables (e.g., using a `.env` file or any other mechanism):
   - `DB_HOST`
   - `DB_PORT`
   - `DB_USER`
   - `DB_PASSWORD`
   - `DB_NAME`
   - `DB_TABLE_NAME`
   - `OPENAI_API_KEY`

3. **Run the Script**  
   ```bash
   python clustering_script.py
   ```
   - The script will create two new columns, `cluster_id` (integer) and `cluster` (text), if they donâ€™t already exist in your target table.
   - K-Means clustering is executed, and ChatGPT names each cluster. The assigned cluster data is then updated in the database and printed to the console as JSON.

## Notes
- The script uses `get_env()` from the `arguments` module to load environment variables. Make sure you have that module set up properly, or replace it with your own environment variable handling.
- The ChatGPT cluster names come from the `generate_cluster_name()` function, which calls the `OpenAI.chat.completions.create()` method. You need an appropriate OpenAI API key with access to the specified model (`gpt-4o-mini` in this example).
- Modify `n_clusters` in the call to `cluster_from_db()` as needed (default is 25).

Feel free to customize this script to suit your needs (e.g., changing the model, altering how you store embeddings, or switching the clustering algorithm).